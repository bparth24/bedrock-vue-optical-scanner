<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Component Test</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }

    .test-container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
      height: 100vh;
      max-height: 100vh;
    }

    .upload-wrapper {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      max-height: calc(100vh - 40px);
    }

    .state-display {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 11px;
      overflow: auto;
      height: calc(100vh - 40px);
      max-height: calc(100vh - 40px);
      border: 1px solid #dee2e6;
      position: sticky;
      top: 20px;
    }

    .state-display h3 {
      margin: 0 0 10px 0;
      font-family: Arial, sans-serif;
      font-size: 14px;
      color: #333;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 8px;
    }

    .state-display pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.3;
    }

    .test-controls {
      background: white;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .test-controls h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #333;
    }

    .control-button {
      margin: 5px;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s ease;
    }

    .control-button:hover {
      background: #0056b3;
    }

    .control-button.danger {
      background: #dc3545;
    }

    .control-button.danger:hover {
      background: #c82333;
    }

    /* Scrollbar styling for better appearance */
    .state-display::-webkit-scrollbar {
      width: 8px;
    }

    .state-display::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .state-display::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .state-display::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    .upload-wrapper::-webkit-scrollbar {
      width: 8px;
    }

    .upload-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .upload-wrapper::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }

    .upload-wrapper::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    @media (max-width: 1024px) {
      .test-container {
        grid-template-columns: 1fr;
        height: auto;
        max-height: none;
      }
      
      .state-display {
        height: 400px;
        max-height: 400px;
        position: static;
      }
      
      .upload-wrapper {
        max-height: 600px;
      }
    }

    @media (max-width: 768px) {
      .test-container {
        padding: 10px;
      }
      
      .upload-wrapper {
        padding: 15px;
        max-height: 500px;
      }
      
      .state-display {
        height: 300px;
        max-height: 300px;
        font-size: 10px;
      }
    }
</style>
</head>
<body>
  <div id="app">
    <div class="test-container">
      <div>
        <h1>Upload Component Test</h1>
        
        <div class="test-controls">
          <h3>Test Controls:</h3>
          <button class="control-button" @click="disabled = !disabled">
            {{ disabled ? 'Enable' : 'Disable' }} Upload
          </button>
          <button class="control-button" @click="hideUploadButton = !hideUploadButton">
            {{ hideUploadButton ? 'Show' : 'Hide' }} Upload Button
          </button>
          <button class="control-button" @click="dragDrop = !dragDrop">
            {{ dragDrop ? 'Disable' : 'Enable' }} Drag & Drop
          </button>
          <button class="control-button" @click="showRecentFiles = !showRecentFiles">
            {{ showRecentFiles ? 'Hide' : 'Show' }} Recent Files
          </button>
          <button class="control-button danger" @click="clearEventLog">
            Clear Event Log
          </button>
        </div>
        
        <div class="upload-wrapper">
          <upload-component
            :hide-upload-button="hideUploadButton"
            :accepted-types="acceptedTypes"
            :disabled="disabled"
            :max-file-size="maxFileSize"
            :drag-drop="dragDrop"
            :show-recent-files="showRecentFiles"
            :max-recent-files="maxRecentFiles"
            :upload-button-text="uploadButtonText"
            @file-uploaded="onFileUploaded"
            @upload-error="onUploadError"
            @upload-progress="onUploadProgress"
            @files-processed="onFilesProcessed" />
        </div>
      </div>
      
      <div class="state-display">
        <h3>Component State & Events:</h3>
        <pre>{{ JSON.stringify({
          settings: {
            hideUploadButton,
            disabled,
            dragDrop,
            showRecentFiles,
            maxFileSize: formatFileSize(maxFileSize),
            acceptedTypes
          },
          stats: {
            totalUploads: eventLog.filter(e => e.event === 'file-uploaded').length,
            totalErrors: eventLog.filter(e => e.event === 'upload-error').length,
            lastUpload: lastUpload ? {
              name: lastUpload.file?.name || 'Unknown',
              size: lastUpload.file?.size ? formatFileSize(lastUpload.file.size) : 'Unknown',
              type: lastUpload.file?.type || 'Unknown'
            } : null
          },
          recentEvents: eventLog.slice(-8)
        }, null, 2) }}</pre>
      </div>
    </div>
  </div>

  <script type="module">
    // Mock UploadComponent
    const UploadComponent = {
      name: 'UploadComponent',
      template: `
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <!-- Hidden File Input -->
          <input 
            ref="fileInput"
            type="file"
            :accept="acceptedTypesString"
            :disabled="disabled"
            multiple
            style="display: none"
            @change="onFileSelect" />

          <!-- Upload Button -->
          <button
            v-if="!hideUploadButton"
            :disabled="disabled"
            :style="{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '8px',
              padding: '12px 20px',
              border: '2px solid #007bff',
              borderRadius: '6px',
              background: disabled ? '#6c757d' : '#007bff',
              color: 'white',
              cursor: disabled ? 'not-allowed' : 'pointer',
              fontSize: '14px',
              fontWeight: '600'
            }"
            @click="triggerFileSelect">
            <span>üìÅ</span>
            <span>{{ uploadButtonText }}</span>
          </button>

          <!-- Drag & Drop Area -->
          <div
            v-if="dragDrop && !hideUploadButton"
            :style="{
              border: isDragOver ? '2px dashed #28a745' : '2px dashed #007bff',
              borderRadius: '8px',
              padding: '40px 20px',
              textAlign: 'center',
              cursor: disabled ? 'not-allowed' : 'pointer',
              background: isDragOver ? '#e8f5e8' : '#f8f9fa',
              opacity: disabled ? 0.6 : 1,
              transform: isDragOver ? 'scale(1.02)' : 'scale(1)',
              transition: 'all 0.2s ease'
            }"
            @click="triggerFileSelect"
            @dragover.prevent="onDragOver"
            @dragleave.prevent="onDragLeave"
            @drop.prevent="onDrop">
            
            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
              <span style="fontSize: '32px'">{{ isDragOver ? 'üìÇ' : 'üìã' }}</span>
              <div style="display: flex; flex-direction: column; gap: 4px;">
                <strong style="fontSize: '16px'; color: '#333'">
                  {{ isDragOver ? 'Drop files here' : 'Drag & drop files' }}
                </strong>
                <small style="fontSize: '12px'; color: '#666'">or click to browse</small>
              </div>
              <div style="fontSize: '12px'; color: '#666'; marginTop: '8px'">
                Accepted: {{ acceptedTypesDisplay }}
              </div>
            </div>
          </div>

          <!-- Processing Progress -->
          <div v-if="processing.length > 0" style="background: #f8f9fa; border: 1px solid #dee2e6; borderRadius: '6px'; padding: '16px';">
            <h4 style="margin: '0 0 12px 0'; fontSize: '14px'; color: '#333';">Processing Files:</h4>
            <div v-for="item in processing" :key="item.id" style="display: flex; alignItems: 'center'; gap: '12px'; marginBottom: '8px';">
              <span style="flex: 1; fontSize: '13px'; color: '#333';">{{ item.file.name }}</span>
              <div style="flex: 2; height: '8px'; background: '#e9ecef'; borderRadius: '4px'; overflow: 'hidden';">
                <div :style="{height: '100%', background: '#28a745', width: item.progress + '%', transition: 'width 0.3s ease'}"></div>
              </div>
              <span style="fontSize: '12px'; color: '#666'; minWidth: '40px'; textAlign: 'right';">{{ item.progress }}%</span>
            </div>
          </div>

          <!-- Recent Files -->
          <div v-if="recentFiles.length > 0 && showRecentFiles" style="background: #f8f9fa; border: 1px solid #dee2e6; borderRadius: '6px'; padding: '16px';">
            <h4 style="margin: '0 0 12px 0'; fontSize: '14px'; color: '#333';">Recent Uploads:</h4>
            <div v-for="file in recentFiles.slice(0, maxRecentFiles)" :key="file.id" 
                 style="display: flex; alignItems: 'center'; gap: '12px'; padding: '8px'; background: 'white'; border: '1px solid #dee2e6'; borderRadius: '4px'; marginBottom: '8px';">
              
              <div style="flex: 1; display: flex; flexDirection: 'column'; gap: '2px';">
                <span style="fontSize: '13px'; fontWeight: '500'; color: '#333';">{{ file.name }}</span>
                <span style="fontSize: '11px'; color: '#666';">({{ formatFileSize(file.size) }})</span>
              </div>
              
              <div v-if="file.preview" style="width: '40px'; height: '40px'; borderRadius: '4px'; overflow: 'hidden'; border: '1px solid #dee2e6';">
                <img :src="file.preview" style="width: '100%'; height: '100%'; objectFit: 'cover';" />
              </div>
              
              <div style="display: flex; gap: '4px';">
                <button @click="reScanFile(file)" style="padding: '4px 8px'; border: 'none'; borderRadius: '3px'; background: '#007bff'; color: 'white'; fontSize: '10px'; cursor: 'pointer';">
                  üîç Scan Again
                </button>
                <button @click="removeRecentFile(file.id)" style="padding: '4px 8px'; border: 'none'; borderRadius: '3px'; background: '#dc3545'; color: 'white'; fontSize: '10px'; cursor: 'pointer';">
                  ‚ùå Remove
                </button>
              </div>
            </div>
          </div>

          <!-- Error Display -->
          <div v-if="uploadError" style="display: flex; alignItems: 'center'; gap: '8px'; padding: '12px'; background: '#f8d7da'; color: '#721c24'; border: '1px solid #f5c6cb'; borderRadius: '6px';">
            <span style="fontSize: '16px';">‚ö†Ô∏è</span>
            <span style="flex: 1; fontSize: '14px';">{{ uploadError }}</span>
            <button @click="clearError" style="background: 'none'; border: 'none'; color: '#721c24'; cursor: 'pointer'; fontSize: '18px'; padding: '0'; width: '20px'; height: '20px';">√ó</button>
          </div>
        </div>
      `,
      props: [
        'hideUploadButton', 'acceptedTypes', 'disabled', 'maxFileSize', 
        'dragDrop', 'showRecentFiles', 'maxRecentFiles', 'uploadButtonText'
      ],
      emits: ['file-uploaded', 'upload-error', 'upload-progress', 'files-processed'],
      data() {
        return {
          isDragOver: false,
          processing: [],
          recentFiles: [],
          uploadError: null
        };
      },
      computed: {
        acceptedTypesString() {
          return this.acceptedTypes.join(',');
        },
        acceptedTypesDisplay() {
          return this.acceptedTypes.map(type => type.split('/')[1].toUpperCase()).join(', ');
        }
      },
      methods: {
        triggerFileSelect() {
          if (this.disabled) return;
          this.$refs.fileInput.click();
        },

        async onFileSelect(event) {
          const files = event.target.files;
          if (files && files.length > 0) {
            await this.processFiles(Array.from(files));
          }
          event.target.value = '';
        },

        onDragOver() {
          if (!this.disabled) this.isDragOver = true;
        },

        onDragLeave() {
          this.isDragOver = false;
        },

        async onDrop(event) {
          if (this.disabled) return;
          this.isDragOver = false;
          const files = event.dataTransfer.files;
          if (files && files.length > 0) {
            await this.processFiles(Array.from(files));
          }
        },

        async processFiles(files) {
          for (const file of files) {
            if (this.validateFile(file)) {
              await this.processFile(file);
            }
          }
        },

        validateFile(file) {
          if (!this.acceptedTypes.some(type => file.type.match(type))) {
            this.setError(`File type ${file.type} not supported`);
            return false;
          }
          if (file.size > this.maxFileSize) {
            this.setError(`File size exceeds maximum ${this.formatFileSize(this.maxFileSize)}`);
            return false;
          }
          return true;
        },

        async processFile(file) {
          const processingId = Date.now() + Math.random();
          const processingItem = { id: processingId, file, progress: 0 };
          
          this.processing.push(processingItem);

          try {
            // Simulate processing
            for (let progress = 0; progress <= 100; progress += 20) {
              processingItem.progress = progress;
              this.$emit('upload-progress', { file, progress });
              await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Convert to data URL
            const dataUrl = await this.fileToDataUrl(file);
            const preview = file.type.startsWith('image/') ? dataUrl : null;

            const fileRecord = {
              id: processingId,
              name: file.name,
              size: file.size,
              type: file.type,
              dataUrl,
              preview,
              uploadedAt: new Date()
            };

            this.recentFiles.unshift(fileRecord);
            if (this.recentFiles.length > this.maxRecentFiles * 2) {
              this.recentFiles = this.recentFiles.slice(0, this.maxRecentFiles * 2);
            }

            this.$emit('file-uploaded', { file, dataUrl, preview, id: processingId });

          } catch (error) {
            this.$emit('upload-error', { error, file });
            this.setError(`Failed to process ${file.name}`);
          } finally {
            this.processing = this.processing.filter(item => item.id !== processingId);
          }
        },

        fileToDataUrl(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(file);
          });
        },

        reScanFile(fileRecord) {
          this.$emit('file-uploaded', {
            file: new File([''], fileRecord.name, { type: fileRecord.type }),
            dataUrl: fileRecord.dataUrl,
            preview: fileRecord.preview,
            id: fileRecord.id,
            isRescan: true
          });
        },

        removeRecentFile(fileId) {
          this.recentFiles = this.recentFiles.filter(file => file.id !== fileId);
        },

        setError(message) {
          this.uploadError = message;
          setTimeout(() => {
            if (this.uploadError === message) {
              this.uploadError = null;
            }
          }, 5000);
        },

        clearError() {
          this.uploadError = null;
        },

        formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
      }
    };

    const { createApp } = Vue;

    createApp({
      components: {
        UploadComponent
      },
      data() {
        return {
          hideUploadButton: false,
          disabled: false,
          dragDrop: true,
          showRecentFiles: true,
          maxRecentFiles: 3,
          uploadButtonText: 'Upload Image',
          acceptedTypes: ['image/png', 'image/jpeg', 'image/bmp', 'image/gif'],
          maxFileSize: 10 * 1024 * 1024, // 10MB
          eventLog: [],
          lastUpload: null
        };
      },
      methods: {
        onFileUploaded(data) {
          this.logEvent('file-uploaded', {
            fileName: data.file?.name || 'Unknown',
            fileSize: data.file?.size || 0,
            isRescan: data.isRescan || false,
            hasPreview: !!data.preview,
            id: data.id
          });
          this.lastUpload = data;
          // Simulate scanning behavior for "Scan Again"
          if (data.isRescan) {
            console.log('üîç Re-scanning file:', data.file?.name);
            this.simulateScanning(data);
          } else {
            console.log('üìÅ File uploaded:', data.file?.name);
          }
          console.log('File uploaded:', data);
        },

        simulateScanning(fileData) {
          // Simulate what would happen when connected to ScanningOrchestratorComponent
          setTimeout(() => {
            const mockResults = [
              { format: 'qr_code', text: 'https://example.com/sample-qr', confidence: 0.95 },
              { format: 'pdf417', text: 'SAMPLE|PDF417|DATA|123456', confidence: 0.87 }
            ];
            
            this.logEvent('scan-completed', {
              fileName: fileData.file?.name,
              results: mockResults,
              isRescan: true
            });
            
            console.log('‚úÖ Scan completed for:', fileData.file?.name, mockResults);
          }, 1000);
        },

        onUploadError(data) {
          this.logEvent('upload-error', data);
          console.error('Upload error:', data);
        },

        onUploadProgress(data) {
          this.logEvent('upload-progress', data);
        },

        onFilesProcessed(data) {
          this.logEvent('files-processed', data);
        },

        logEvent(event, data = null) {
          this.eventLog.push({
            timestamp: new Date().toLocaleTimeString(),
            event,
            data
          });
        },

        clearEventLog() {
          this.eventLog = [];
          this.lastUpload = null;
        },

        formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
      }
    }).mount('#app');
  </script>
</body>
</html>